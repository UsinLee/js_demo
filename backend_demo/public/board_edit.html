<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Board ìˆ˜ì • | CODE</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#232427] text-[#e5e7eb]">

  <!-- ì œëª© -->
  <header class="py-10 flex justify-center">
    <h1 class="text-5xl font-bold">EDIT</h1>
  </header>

  <!-- <main> í¼ êµ¬ì„±
      ì œëª© ì…ë ¥ í•„ë“œ (id="title")
      ë‚´ìš© ì…ë ¥ í•„ë“œ (id="content")
      ì²¨ë¶€íŒŒì¼ í•„ë“œ (id="fileInput")
      ë“±ë¡ ë²„íŠ¼ (<button>)
      ì‚¬ìš©ìê°€ ê¸°ì¡´ ê²Œì‹œê¸€ì„ ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡ í¼ì„ êµ¬ì„±-->
  <main class="max-w-3xl mx-auto mt-10 bg-[#2b2c30] p-6 rounded-xl shadow space-y-6">

    <div>
      <label for="title" class="block mb-2 text-sm font-semibold text-gray-300">ì œëª©</label>
      <input id="title" type="text" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
             class="w-full px-4 py-2 bg-[#40414f] text-white border border-[#565869] rounded focus:outline-none focus:ring-2 focus:ring-[#10a37f]">
    </div>

    <div>
      <label for="content" class="block mb-2 text-sm font-semibold text-gray-300">ë‚´ìš©</label>
      <textarea id="content" rows="8" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
                class="w-full px-4 py-2 bg-[#40414f] text-white border border-[#565869] rounded focus:outline-none focus:ring-2 focus:ring-[#10a37f]"></textarea>
    </div>

    <div>
      <label for="fileInput" class="block mb-2 text-sm font-semibold text-gray-300">ì²¨ë¶€íŒŒì¼</label>
      <input id="fileInput" type="file"
             class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4
                    file:rounded file:border-0 file:text-sm file:font-semibold
                    file:bg-[#10a37f] file:text-white hover:file:bg-[#0d8f6d]" />
      <p id="existingFile" class="text-sm text-gray-400 mt-2"></p>
    </div>    

    <div class="text-right">
      <button class="bg-[#10a37f] hover:bg-[#0d8f6d] text-white font-semibold px-6 py-2 rounded">
        ìˆ˜ì • ì™„ë£Œ
      </button>
    </div>
  </main> 

  <script type="module" src="utils/authFetch.js"></script>
  
  <script type="module">
    import { authFetch } from "./utils/authFetch.js";
  
    // âœ… URL íŒŒë¼ë¯¸í„°ì—ì„œ ìˆ˜ì • ëŒ€ìƒ ê²Œì‹œê¸€ ID ì¶”ì¶œ
    const params = new URLSearchParams(window.location.search);
    const postId = params.get("index");
  
    // âœ… ë¡œê·¸ì¸ ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const currentUser = JSON.parse(localStorage.getItem("currentUser") || "{}");
  
    // âœ… ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
    if (!currentUser || !currentUser.accessToken || !currentUser.refreshToken) {
      alert("ë¡œê·¸ì¸ í›„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      window.location.href = `login.html?redirect=${encodeURIComponent(location.href)}`;
    }
  
    // âœ… DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const titleInput = document.getElementById("title");
    const contentInput = document.getElementById("content");
    const fileInput = document.getElementById("fileInput");
    const submitBtn = document.querySelector("button");
  
    // âœ… ê²Œì‹œê¸€ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° (ğŸ”¥ fetch â†’ authFetch ë¡œ êµì²´)
    authFetch(`http://localhost:4000/posts/${postId}`)
      .then((res) => {
        if (!res.ok) throw new Error("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return res.json();
      })
      .then((post) => {
        // ê¶Œí•œ ì²´í¬: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ìˆ˜ì • ê°€ëŠ¥
        if (currentUser.username !== post.author) {
          alert("ë³¸ì¸ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          window.location.href = "index.html";
          return;
        }
  
        // ê¸°ì¡´ ê²Œì‹œê¸€ ì •ë³´ ì…ë ¥ë€ì— ì±„ìš°ê¸°
        titleInput.value = post.title;
        contentInput.value = post.content;
      })
      .catch((err) => {
        console.error("ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
        alert("ê²Œì‹œê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        window.location.href = "index.html";
      });
  
    // âœ… ìˆ˜ì • ìš”ì²­
    submitBtn.addEventListener("click", async () => {
      const title = titleInput.value.trim();
      const content = contentInput.value.trim();
      const file = fileInput.files[0];
    
      if (!title || !content) {
        alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
    
      const fileName = file ? file.name : "";
    
      try {
        const res = await authFetch(`http://localhost:4000/posts/${postId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ title, content, fileName }),
        });
  
        const data = await res.json();
  
        if (!res.ok) throw new Error(data.message || "ìˆ˜ì • ì‹¤íŒ¨");
  
        alert(data.message || "ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
        location.href = `board_view.html?index=${postId}`;
      } catch (err) {
        console.error("ê²Œì‹œê¸€ ìˆ˜ì • ì˜¤ë¥˜:", err);
        alert("ê²Œì‹œê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    });
  </script>
  
  

</body>
</html>
