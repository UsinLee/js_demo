<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê²Œì‹œê¸€ ë³´ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#232427] text-[#e5e7eb]">
  <!-- ğŸ” ë¡œê·¸ì¸ ìƒíƒœ ë° ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ 
       ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ì´ë¦„ì„ í‘œì‹œí•˜ê±°ë‚˜ ë¡œê·¸ì¸ ë§í¬ë¥¼ ë³´ì—¬ì¤Œ
       ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œë§Œ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì´ ë³´ì´ë„ë¡ ì„¤ì •ë¨ (hidden í´ë˜ìŠ¤ ì œê±°)-->
  <div class="max-w-3xl mx-auto mt-6 px-4">
    <div class="flex justify-end items-center gap-4">
      <div id="loginStatus" class="text-sm text-gray-400"></div>
      <button id="logoutBtn" class="text-sm text-red-400 hover:underline hidden">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <!-- ğŸ“ ê²Œì‹œê¸€ ë‚´ìš© í‘œì‹œ ì˜ì—­ 
       ê²Œì‹œê¸€ ì •ë³´ë¥¼ ì¶œë ¥í•˜ëŠ” ì˜ì—­
       ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ì€ ì‘ì„±ì ë³¸ì¸ì¼ ê²½ìš°ì—ë§Œ ë³´ì´ë„ë¡ JavaScriptì—ì„œ ì œì–´-->
  <main class="max-w-3xl mx-auto mt-10 p-6 bg-[#2b2c30] rounded-xl shadow space-y-6">
    <h1 id="postTitle" class="text-2xl font-bold"></h1>
    <p id="postAuthor" class="text-sm text-gray-400"></p>
    <p id="postDate" class="text-sm text-gray-400"></p>
    <hr class="border-[#3a3b3e]" />
    <p id="postContent" class="text-base leading-relaxed whitespace-pre-wrap"></p>

    <!-- ë¡œê·¸ì¸ ìƒíƒœ ë° ì²¨ë¶€íŒŒì¼ ì˜ì—­ -->
    <div id="loginStatus" class="text-sm text-right text-gray-400 px-4 mt-4"></div>
    <div id="fileBox" class="text-sm text-gray-400 mt-3"></div>

    <!-- ê²Œì‹œê¸€ í¸ì§‘ ë° ì‚­ì œ ë²„íŠ¼ -->
    <div class="text-right">
      <a href="index.html" class="text-[#10a37f] hover:underline text-sm">â† ëŒì•„ê°€ê¸°</a>
      <a id="editBtn" class="text-sm text-blue-400 hover:underline cursor-pointer hidden">âœï¸ ìˆ˜ì •</a>
      <button id="deleteBtn" class="text-sm text-red-400 hover:underline hidden">ğŸ—‘ ì‚­ì œ</button>
    </div>
  </main>

  <!-- ğŸ’¬ ëŒ“ê¸€& ëŒ€ëŒ“ê¸€ ì…ë ¥ ì˜ì—­ 
       ëŒ“ê¸€ ëª©ë¡ì„ #commentListì— ë™ì ìœ¼ë¡œ ì¶œë ¥
       ëŒ“ê¸€ ì…ë ¥ í›„ ë“±ë¡ ë²„íŠ¼ìœ¼ë¡œ ìƒˆ ëŒ“ê¸€ ì¶”ê°€-->
  <section class="max-w-3xl mx-auto mt-8 space-y-4">
    <h2 class="text-lg font-bold text-gray-300">ğŸ’¬ ëŒ“ê¸€</h2>
    <div id="commentList" class="space-y-2"></div>
    <div class="flex gap-2 mt-4">
      <input type="text" id="commentInput" maxlength="200" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" class="flex-grow px-4 py-2 bg-[#40414f] text-white border border-[#565869] rounded" />
      <p id="charCount" class="text-xs text-right text-gray-400">0 / 200ì</p>
      <button id="commentSubmit" class="px-4 py-2 bg-[#10a37f] text-white rounded hover:bg-[#0d8f6d]">ë“±ë¡</button>
    </div>
  </section>

  <script type="module" src="utils/authFetch.js"></script>

  <script type="module">
    import { authFetch } from "./utils/authFetch.js";

    // âœ… ê²Œì‹œê¸€ ID íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸° (ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì—ì„œ index ëŒ€ì‹  idë¡œ ê´€ë¦¬)
    const params = new URLSearchParams(window.location.search);
    const postId = params.get("index");

    // âœ… í˜„ì¬ ë¡œê·¸ì¸ ìœ ì € ì •ë³´ + í† í°
    let currentUser = JSON.parse(localStorage.getItem("currentUser") || "{}");
    const token = currentUser.token;

    // âœ… DOM ìš”ì†Œë“¤
    const loginStatus = document.getElementById("loginStatus");
    const logoutBtn = document.getElementById("logoutBtn");
    const titleEl = document.getElementById("postTitle");
    const authorEl = document.getElementById("postAuthor");
    const dateEl = document.getElementById("postDate");
    const contentEl = document.getElementById("postContent");
    const editBtn = document.getElementById("editBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const fileBox = document.getElementById("fileBox");

    // âœ… ë¡œê·¸ì¸ ìƒíƒœ UI í‘œì‹œ
  
    try {
      currentUser = JSON.parse(localStorage.getItem("currentUser"));
    } catch (e) {
      console.warn("currentUser íŒŒì‹± ì˜¤ë¥˜:", e);
    }

    if (currentUser && currentUser.username) {
      loginStatus.textContent = `ğŸ‘‹ ${currentUser.username}ë‹˜`;
      logoutBtn.classList.remove("hidden");
    } else {
      const currentUrl = encodeURIComponent(location.href);
      loginStatus.innerHTML = `<a href="login.html?redirect=${currentUrl}" class="text-blue-400 hover:underline">ğŸ” ë¡œê·¸ì¸</a>`;
      logoutBtn.classList.add("hidden");
    }

    logoutBtn.addEventListener("click", () => {
      if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        localStorage.removeItem("currentUser");
        alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.reload();
      }
    });

    let currentPost = null; // ì „ì—­ìœ¼ë¡œ ê²Œì‹œê¸€ ì •ë³´ë¥¼ ì €ì¥

    // ê²Œì‹œê¸€ ë¡œë”© â†’ ëŒ“ê¸€ë„ ì´ ì•ˆì—ì„œ ê°™ì´ í˜¸ì¶œ
    authFetch(`http://localhost:4000/posts/${postId}`)
      .then((res) => {
        if (!res.ok) throw new Error("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return res.json();
      })
    .then((post) => {
      currentPost = post; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
      titleEl.textContent = post.title;
      authorEl.textContent = `ì‘ì„±ì: ${post.author}`;
      dateEl.textContent = `ì‘ì„±ì¼: ${post.created_at}`;
      contentEl.textContent = post.content;

      if (post.file_name) {
        fileBox.innerHTML = `ğŸ“ ì²¨ë¶€íŒŒì¼: <span class="text-white">${post.file_name}</span>`;
      }

      if (currentUser && currentUser.username === post.author) {
        editBtn.classList.remove("hidden");
        deleteBtn.classList.remove("hidden");
        editBtn.href = `board_edit.html?index=${post.id}`;
      }

      // âœ… ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œëœ ë‹¤ìŒì—ë§Œ ëŒ“ê¸€ ë¡œë”©
      loadComments(postId, post);
    })
    .catch((err) => {
      document.body.innerHTML = `<p class='text-center mt-10 text-red-400'>ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
      console.error(err);
    });

    // âœ… ê²Œì‹œê¸€ ì‚­ì œ
    deleteBtn.addEventListener("click", async () => {
      if (!confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
      if (!token) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        return;
      }
    
      try {
        const res = await authFetch(`http://localhost:4000/posts/${postId}`, {
          method: "DELETE"
        });
    
        const data = await res.json();
    
        if (!res.ok) {
          alert(data.message || "ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          return;
        }
    
        alert("ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        window.location.replace("index.html");
      } catch (err) {
        console.error("ì‚­ì œ ìš”ì²­ ì‹¤íŒ¨:", err);
        alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
        
    async function deleteComment(commentId) {
      try {
        const res = await authFetch(`http://localhost:4000/comments/${commentId}`, {
          method: "DELETE"
        });
    
        const result = await res.json();
    
        if (!res.ok) {
          alert(result.message || "ì‚­ì œ ì‹¤íŒ¨");
          return;
        }
    
        alert("ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        await loadComments(postId, currentPost); // ëŒ“ê¸€ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
      } catch (err) {
        console.error("ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨:", err);
        alert("ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }
    

    /** âœ… ëŒ“ê¸€ ë Œë”ë§ í•¨ìˆ˜
        ê²Œì‹œê¸€ì— ì‘ì„±ëœ ëª¨ë“  ëŒ“ê¸€ê³¼ ëŒ€ëŒ“ê¸€ì„ ì¶œë ¥í•¨.
        ê° ëŒ“ê¸€ì€ ë‹¤ìŒì„ í¬í•¨:
        ì‘ì„±ì ì´ë¦„, ë‚ ì§œ, ì‚­ì œ ì—¬ë¶€
        "ì‘ì„±ì" ë±ƒì§€
        "ë‹µê¸€", "ì‚­ì œ" ë²„íŠ¼
        ëŒ“ê¸€ ë‚´ë¶€ì˜ ê¸°ëŠ¥:
        âœ… ë‹µê¸€ ë²„íŠ¼ í´ë¦­ ì‹œ ëŒ€ëŒ“ê¸€ ì…ë ¥ì°½ ìƒì„±
        âœ… ëŒ€ëŒ“ê¸€ ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì‹œ ëŒ€ëŒ“ê¸€ repliesì— ì¶”ê°€
        âœ… ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ ì…ë ¥ì°½ ì œê±°, ë‹¤ì‹œ ë‹µê¸€ ë²„íŠ¼ í‘œì‹œ
        âœ… ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ë³¸ì¸ ëŒ“ê¸€ì´ë©´ "ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤."ë¡œ í‘œì‹œ**/
    function renderComments(comments, post) {
      if (!post) return;

      commentList.innerHTML = "";

      comments.forEach((comment, idx) => {
        const el = document.createElement("div");
        el.className = "bg-[#3a3b3e] p-3 rounded text-sm text-gray-200 space-y-1";

        const isPostAuthor = comment.author === post.author;
        el.innerHTML = `
          <div class="view-mode">
            <p class="comment-content ${comment.deleted ? 'italic text-gray-500' : ''}">${comment.content}</p>
            <p class="text-xs text-gray-400">
              ì‘ì„±ì: ${comment.author}
              ${isPostAuthor ? '<span class="ml-1 px-2 py-[1px] text-[11px] bg-gray-600 text-white rounded">ì‘ì„±ì</span>' : ''}
              | ${comment.created_at}
            </p>
            <div class="flex gap-2 justify-end text-xs text-gray-400">
              <button class="reply-btn underline" data-index="${idx}">ë‹µê¸€</button>
              <button class="delete-btn underline text-red-400" data-index="${idx}">ì‚­ì œ</button>
            </div>
          </div>
          <div class="replies space-y-2 ml-4 mt-2"></div>
        `;

        commentList.appendChild(el);

        const replyContainer = el.querySelector(".replies");
        (comment.replies || []).forEach(reply => {
          const isPostAuthor = reply.author === post.author;
          const replyEl = document.createElement("div");
          replyEl.className = "bg-[#2f3033] p-2 rounded text-xs text-gray-300";
          replyEl.innerHTML = `
            <p>${reply.content}</p>
            <p class="text-[11px] text-gray-400 mt-1">
              ì‘ì„±ì: ${reply.author}
              ${isPostAuthor ? '<span class="ml-1 px-1 py-[1px] bg-gray-600 text-white rounded text-[10px]">ì‘ì„±ì</span>' : ''}
              | ${reply.created_at}
            </p>
          `;
          replyContainer.appendChild(replyEl);
        });

        const replyBtn = el.querySelector(".reply-btn");
        replyBtn.addEventListener("click", () => {
          if (!currentUser) {
            alert("ë‹µê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            window.location.href = `login.html?redirect=${encodeURIComponent(location.href)}`;
            return;
          }

          if (el.querySelector(".reply-form")) return;
          replyBtn.classList.add("hidden");

          const form = document.createElement("div");
          form.className = "reply-form mt-2 space-y-1";
          form.innerHTML = `
            <input type="text" maxlength="200"
              class="w-full px-2 py-1 bg-[#40414f] text-white border border-[#565869] rounded"
              placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" />
            <div class="flex justify-between items-center">
              <p class="text-xs text-gray-400" id="replyCharCount">0 / 200ì</p>
              <div class="flex gap-2">
                <button class="submit-btn px-3 py-1 bg-[#10a37f] text-white rounded text-xs">ë“±ë¡</button>
                <button class="cancel-btn px-3 py-1 bg-[#565869] text-white rounded text-xs">ì·¨ì†Œ</button>
              </div>
            </div>
          `;

          replyContainer.appendChild(form);

          const input = form.querySelector("input");
          const count = form.querySelector("#replyCharCount");
          const submitBtn = form.querySelector(".submit-btn");
          const cancelBtn = form.querySelector(".cancel-btn");

          input.addEventListener("input", () => {
            count.textContent = `${input.value.length} / 200ì`;
            count.classList.toggle("text-red-400", input.value.length > 180);
          });

          input.focus();

          submitBtn.addEventListener("click", () => {
            const text = input.value.trim();
            if (!text) return;

            const reply = {
              content: text,
              created_at: new Date().toLocaleString("ko-KR", {
                year: "2-digit", month: "2-digit", day: "2-digit",
                hour: "2-digit", minute: "2-digit"
              }),
              author: currentUser.username
            };

            if (!post.comments[idx].replies)
              post.comments[idx].replies = [];

            post.comments[idx].replies.push(reply);
            localStorage.setItem("posts", JSON.stringify(posts));
            renderComments(post.comments);
          });

          cancelBtn.addEventListener("click", () => {
            form.remove();
            replyBtn.classList.remove("hidden");
          });
        });

        el.querySelector(".delete-btn").addEventListener("click", () => {
          const comment = comments[idx];
          if (comment.author_id !== currentUser?.id) {
            alert("ë³¸ì¸ë§Œ ëŒ“ê¸€ì„ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
        
          if (confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            deleteComment(comment.id);
          }
        });
        
      });
    }

    /** âœ… ëŒ“ê¸€ ì‘ì„± ì´ë²¤íŠ¸
        ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
        ëŒ“ê¸€ì„ í˜„ì¬ ê²Œì‹œê¸€ì˜ comments ë°°ì—´ì— ì¶”ê°€
        localStorageì— ì €ì¥ í›„ ë‹¤ì‹œ ë Œë”ë§**/
    commentSubmit.addEventListener("click", async () => {
      if (!currentUser || !token) {
        alert("ëŒ“ê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        window.location.href = `login.html?redirect=${encodeURIComponent(location.href)}`;
        return;
      }
    
      const content = commentInput.value.trim();
      if (!content) return;
    
      try {
        const res = await authFetch("http://localhost:4000/comments", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            postId,
            content,
            parentId: null
          })
        });
    
        const result = await res.json();
        commentInput.value = "";
        await loadComments(postId, currentPost); // ë“±ë¡ í›„ ìµœì‹  ëŒ“ê¸€ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
      } catch (err) {
        console.error("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:", err);
        alert("ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
        
        

    /** âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ“ê¸€ ìë™ ë Œë”ë§
        í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆì„ ë•Œ, ê¸°ì¡´ ëŒ“ê¸€ì´ ìˆë‹¤ë©´ ìë™ìœ¼ë¡œ ì¶œë ¥**/
    async function loadComments(postId, post) {
      try {
        const res = await authFetch(`http://localhost:4000/comments/${postId}`);
        const data = await res.json();

        renderComments(data, post);
      } catch (err) {
        console.error("ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
      }
    }
    
    // ë§ˆì§€ë§‰ì— í˜¸ì¶œ
    loadComments(postId, currentPost);
        
    // ğŸ” ë’¤ë¡œê°€ê¸° ì‹œ í˜ì´ì§€ ìºì‹œ ë¬´íš¨í™”
    window.addEventListener("pageshow", (event) => {
      const navType = performance.getEntriesByType("navigation")[0]?.type;
      if (event.persisted || navType === "back_forward") {
        location.reload(); // ê°•ì œ ìƒˆë¡œê³ ì¹¨
      }
    });


  </script>

</body>
</html>