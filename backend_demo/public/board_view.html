<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê²Œì‹œê¸€ ë³´ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#232427] text-[#e5e7eb]">
  <!-- â¬‡ ë¡œê·¸ì¸ ìƒíƒœ & ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
  <div class="max-w-3xl mx-auto mt-6 px-4">
    <div class="flex justify-end items-center gap-4">
      <div id="loginStatus" class="text-sm text-gray-400"></div>
      <button id="logoutBtn" class="text-sm text-red-400 hover:underline hidden">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <main class="max-w-3xl mx-auto mt-10 p-6 bg-[#2b2c30] rounded-xl shadow space-y-6">
    <h1 id="postTitle" class="text-2xl font-bold"></h1>
    <p id="postAuthor" class="text-sm text-gray-400"></p>
    <!-- ì‘ì„±ì¼ & ë¡œê·¸ì¸ ìƒíƒœ í•œ ì¤„ì— ë°°ì¹˜ -->
    <p id="postDate" class="text-sm text-gray-400"></p>
    <hr class="border-[#3a3b3e]" />
    <p id="postContent" class="text-base leading-relaxed whitespace-pre-wrap"></p>

    <div id="loginStatus" class="text-sm text-right text-gray-400 px-4 mt-4"></div>


    <div id="fileBox" class="text-sm text-gray-400 mt-3"></div>

    <div class="text-right">
      <a href="index.html" class="text-[#10a37f] hover:underline text-sm">â† ëŒì•„ê°€ê¸°</a>
      <a id="editBtn" class="text-sm text-blue-400 hover:underline cursor-pointer hidden">âœï¸ ìˆ˜ì •</a>
      <button id="deleteBtn" class="text-sm text-red-400 hover:underline hidden">ğŸ—‘ ì‚­ì œ</button>
    </div>
  </main>

  <section class="max-w-3xl mx-auto mt-8 space-y-4">
    <h2 class="text-lg font-bold text-gray-300">ğŸ’¬ ëŒ“ê¸€</h2>
  
    <!-- ëŒ“ê¸€ ëª©ë¡ -->
    <div id="commentList" class="space-y-2"></div>
  
    <!-- ëŒ“ê¸€ ì…ë ¥ -->
    <div class="flex gap-2 mt-4">
      <input
        type="text"
        id="commentInput"
        maxlength="200"
        placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"
        class="flex-grow px-4 py-2 bg-[#40414f] text-white border border-[#565869] rounded"
      />
      <p id="charCount" class="text-xs text-right text-gray-400">0 / 200ì</p>
      <button
        id="commentSubmit"
        class="px-4 py-2 bg-[#10a37f] text-white rounded hover:bg-[#0d8f6d]">
        ë“±ë¡
      </button>
    </div>
  </section>


  <script>
    // URLì—ì„œ index=ê°’ ì½ê¸°
    const params = new URLSearchParams(window.location.search);
    const index = parseInt(params.get("index"));
    const posts = JSON.parse(localStorage.getItem("posts") || "[]");
    
    // ëŒ“ê¸€ ê¸°ëŠ¥
    const commentList = document.getElementById("commentList");
    const commentInput = document.getElementById("commentInput");
    const commentSubmit = document.getElementById("commentSubmit");

    const userInfo = JSON.parse(localStorage.getItem("currentUser"));
    const loginStatus = document.getElementById("loginStatus");
    const logoutBtn = document.getElementById("logoutBtn");

    const currentUser = JSON.parse(localStorage.getItem("currentUser"));

   

    if (userInfo) {
      loginStatus.textContent = `ğŸ‘‹ ${userInfo.username}ë‹˜`;
      logoutBtn.classList.remove("hidden");
    } else {
      // ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ ë•Œ ë§í¬ ë§Œë“¤ê¸° (login.html?redirect=í˜„ì¬í˜ì´ì§€ì£¼ì†Œ)
      const currentUrl = encodeURIComponent(location.href);
      loginStatus.innerHTML = `<a href="login.html?redirect=${encodeURIComponent(location.href)}" class="text-blue-400 hover:underline">ğŸ” ë¡œê·¸ì¸</a>`;
      logoutBtn.classList.add("hidden");

    }


    
    logoutBtn.addEventListener("click", () => {
      if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        localStorage.removeItem("currentUser");
        alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.reload();
      }
    });


    commentInput.addEventListener("input", () => {
      const len = commentInput.value.length;
      document.getElementById("charCount").textContent = `${len} / 200ì`;
    });

    if (isNaN(index) || index < 0 || index >= posts.length) {
      document.body.innerHTML = "<p class='text-center mt-10 text-red-400'>ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²Œì‹œê¸€ì…ë‹ˆë‹¤.</p>";
    } else {
      const post = posts[index]; // ìµœì‹ ê¸€ì´ ìœ„ë¡œ ìŒ“ì˜€ìœ¼ë¯€ë¡œ ì—­ìˆœ

      document.getElementById("postTitle").textContent = post.title;
      document.getElementById("postAuthor").textContent = `ì‘ì„±ì: ${post.author}`;
      document.getElementById("postDate").textContent = `ì‘ì„±ì¼: ${post.date}`;
      document.getElementById("postContent").textContent = post.content;
      document.getElementById("editBtn").href = `board_edit.html?index=${index}`;

      // âœ… ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ê¶Œí•œ ì œì–´
      if (currentUser && currentUser.username === post.author) {
        document.getElementById("editBtn").classList.remove("hidden");
        document.getElementById("deleteBtn").classList.remove("hidden");
      } else {
        document.getElementById("editBtn").classList.add("hidden");
        document.getElementById("deleteBtn").classList.add("hidden");
      }

      // ì²¨ë¶€íŒŒì¼ í‘œì‹œ
      if (post.fileName) {
        const fileBox = document.getElementById("fileBox");
        fileBox.innerHTML = `ğŸ“ ì²¨ë¶€íŒŒì¼: <span class="text-white">${post.fileName}</span>`;
      }
    }

    // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
    document.getElementById("deleteBtn").addEventListener("click", () => {
        if (!confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
        const posts = JSON.parse(localStorage.getItem("posts") || "[]");
    
        posts.splice(index, 1); // í•´ë‹¹ indexì˜ ê²Œì‹œê¸€ ì‚­ì œ
    
        localStorage.setItem("posts", JSON.stringify(posts));
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        window.location.replace("index.html");
    });



    function renderComments(comments) {
      commentList.innerHTML = "";
    
      comments.forEach((comment, idx) => {
        const el = document.createElement("div");
        el.className = "bg-[#3a3b3e] p-3 rounded text-sm text-gray-200 space-y-1";

        // âœ… ê²Œì‹œê¸€ ì‘ì„±ìì¸ì§€ í™•ì¸
        const isPostAuthor = comment.author === posts[index].author;
    
        el.innerHTML = `
          <div class="view-mode">
            <p class="comment-content ${comment.deleted ? 'italic text-gray-500' : ''}">
              ${comment.content}
            </p>
            <p class="text-xs text-gray-400">
              ì‘ì„±ì: ${comment.author}
              ${isPostAuthor ? '<span class="ml-1 px-2 py-[1px] text-[11px] bg-gray-600 text-white rounded">ì‘ì„±ì</span>' : ''}
              | ${comment.date}
            </p>
            <div class="flex gap-2 justify-end text-xs text-gray-400">
              <button class="reply-btn underline" data-index="${idx}">ë‹µê¸€</button>
              <button class="delete-btn underline text-red-400" data-index="${idx}">ì‚­ì œ</button>
            </div>
          </div>
          <div class="replies space-y-2 ml-4 mt-2"></div>
        `;
    
        commentList.appendChild(el);
    
        const replyContainer = el.querySelector(".replies");
        (comment.replies || []).forEach(reply => {
          const isPostAuthor = reply.author === posts[index].author;
        
          const replyEl = document.createElement("div");
          replyEl.className = "bg-[#2f3033] p-2 rounded text-xs text-gray-300";
          replyEl.innerHTML = `
            <p>${reply.content}</p>
            <p class="text-[11px] text-gray-400 mt-1">
              ì‘ì„±ì: ${reply.author}
              ${isPostAuthor ? '<span class="ml-1 px-1 py-[1px] bg-gray-600 text-white rounded text-[10px]">ì‘ì„±ì</span>' : ''}
              | ${reply.date}
            </p>
          `;
          replyContainer.appendChild(replyEl);
        });
        
    
        const replyBtn = el.querySelector(".reply-btn");

        replyBtn.addEventListener("click", () => {
          const currentUser = JSON.parse(localStorage.getItem("currentUser"));
          if (!currentUser) {
            alert("ë‹µê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            window.location.href = `login.html?redirect=${encodeURIComponent(location.href)}`;
            return;
          }

          // âœ… ì¤‘ë³µ ìƒì„± ë°©ì§€
          if (el.querySelector(".reply-form")) return;

          // âœ… ë‹µê¸€ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
          replyBtn.classList.add("hidden");

          const form = document.createElement("div");
          form.className = "reply-form mt-2 space-y-1";

          form.innerHTML = `
            <input type="text" maxlength="200"
              class="w-full px-2 py-1 bg-[#40414f] text-white border border-[#565869] rounded"
              placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" />
            <div class="flex justify-between items-center">
              <p class="text-xs text-gray-400" id="replyCharCount">0 / 200ì</p>
              <div class="flex gap-2">
                <button class="submit-btn px-3 py-1 bg-[#10a37f] text-white rounded text-xs">ë“±ë¡</button>
                <button class="cancel-btn px-3 py-1 bg-[#565869] text-white rounded text-xs">ì·¨ì†Œ</button>
              </div>
            </div>
          `;

          replyContainer.appendChild(form);

          const input = form.querySelector("input");
          const count = form.querySelector("#replyCharCount");
          const submitBtn = form.querySelector(".submit-btn");
          const cancelBtn = form.querySelector(".cancel-btn");

          input.addEventListener("input", () => {
            count.textContent = `${input.value.length} / 200ì`;
            count.classList.toggle("text-red-400", input.value.length > 180);
          });

          input.focus();

          // âœ… ë“±ë¡ ë²„íŠ¼
          submitBtn.addEventListener("click", () => {
            const text = input.value.trim();
            if (!text) return;

            const reply = {
              content: text,
              date: new Date().toLocaleString("ko-KR", {
                year: "2-digit", month: "2-digit", day: "2-digit",
                hour: "2-digit", minute: "2-digit"
              }),
              author: currentUser.username
            };

            if (!posts[index].comments[idx].replies)
              posts[index].comments[idx].replies = [];

            posts[index].comments[idx].replies.push(reply);
            localStorage.setItem("posts", JSON.stringify(posts));
            renderComments(posts[index].comments);
          });

          // âœ… ì·¨ì†Œ ë²„íŠ¼
          cancelBtn.addEventListener("click", () => {
            form.remove();
            replyBtn.classList.remove("hidden"); // ë‹µê¸€ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê¸°
          });
        });

    
        el.querySelector(".delete-btn").addEventListener("click", () => {
          const comment = posts[index].comments[idx];
        
          if (comment.author !== currentUser?.username) {
            alert("ë³¸ì¸ë§Œ ëŒ“ê¸€ì„ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
        
          if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        
          comment.content = "ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤.";
          comment.deleted = true; // â›³ ì„ íƒì ìœ¼ë¡œ í‘œì‹œìš© í”Œë˜ê·¸
          localStorage.setItem("posts", JSON.stringify(posts));
          renderComments(posts[index].comments);
        });        
      });
    }
    
    

commentSubmit.addEventListener("click", () => {
  const currentUser = JSON.parse(localStorage.getItem("currentUser"));
  if (!currentUser) {
    alert("ëŒ“ê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    window.location.href = `login.html?redirect=${encodeURIComponent(location.href)}`;
    return;
  }

  const content = commentInput.value.trim();
  if (!content) return;

  const date = new Date().toLocaleString("ko-KR", {
    year: "2-digit", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit"
  });

  const posts = JSON.parse(localStorage.getItem("posts") || "[]");
  const post = posts[index];

  if (!post.comments) post.comments = [];
  post.comments.push({ 
    content, 
    date,
    author: currentUser.username // âœ… ëŒ“ê¸€ ì‘ì„±ì
  });

  localStorage.setItem("posts", JSON.stringify(posts));
  commentInput.value = "";
  renderComments(post.comments);
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
renderComments(posts[index].comments || []);

  
  
  </script>

</body>
</html>
