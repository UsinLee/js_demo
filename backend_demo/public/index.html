<!-- HTML 문서임을 선언하는 <!DOCTYPE html>과 문서의 기본 언어를 한국어(ko)로 설정한 태그 -->
<!DOCTYPE html> 
<html lang="ko">
<!-- head 내부에서 문자 인코딩 설정(UTF-8), 반응형 설정(viewport), 제목 설정, Tailwind CSS를 외부 CDN으로 불러오기 -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CODE</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<!-- 본문 배경색과 글자색을 설정하고, 전체 레이아웃을 가운데 정렬(mx-auto), 위쪽 여백(mt-10), 항목 간 여백(space-y-6)으로 정리 -->
<body class="bg-[#232427] text-[#e5e7eb]">
  <div class="max-w-3xl mx-auto mt-10 space-y-6">
    <!-- 이 부분은 페이지 상단에 제목을 표시하는 영역 -->
    <div class="board-wrapper">
      <!-- py-10은 위아래 패딩을 크게 줘서 제목과 다른 요소들 사이의 간격을 확보해주고,
          flex justify-center items-center는 제목을 가로·세로 중앙 정렬해.-->
      <header class="py-10 flex justify-center items-center ">
          <!-- text-5xl font-bold는 텍스트 크기와 굵기, text-white는 색상을 하얗게 설정 -->
          <h1 class="text-5xl font-bold">
            <a href="index.html" class="text-white hover:underline">CODE</a>
          </h1>
          
          
      </header>
    </div>

    <!-- 이 부분은 로그인 상태를 표시하는 영역 -->  
    <div class="flex justify-end items-center gap-4">
      <!-- ✅ 로그인 상태 or 로그인 버튼 -->
      <!-- loginStatus는 로그인 상태 메시지나 로그인 버튼을 동적으로 표시하기 위한 div-->
      <div id="loginStatus" class="text-sm text-gray-400"></div>
      <!-- 🔓 로그아웃 버튼 -->
      <!--logoutBtn은 로그인한 경우 보이게 되는 로그아웃 버튼, 기본 상태에서는 hidden 클래스로 숨겨져 있음-->
      <button id="logoutBtn" class="text-sm text-red-400 hover:underline hidden">로그아웃</button>      
    </div>
    
    <!--실제 게시글 리스트가 출력될 영역, JavaScript에서 이 div에 게시글 항목들을 innerHTML로 넣어줌-->
    <!-- bg-[#2b2c30]은 배경색, rounded-xl은 모서리 둥글기, shadow는 그림자 효과.
        mt-8은 상단 여백, mx-auto는 가운데 정렬-->
    <!-- id="postList": 게시글 목록이 자바스크립트로 여기에 동적으로 삽입됨 -->
    <div id="postList" class="max-w-3xl mx-auto mt-8 bg-[#2b2c30] rounded-xl shadow pd-10">
      <!-- 게시글 목록 -->
    </div>



    <!-- max-w-3xl: 최대 너비를 설정해서 페이지 가운데로 정렬되게.
        mx-auto: 양쪽 마진을 자동으로, 즉 가운데 정렬.
        mt-8: 위쪽 여백 (margin-top: 2rem)
        flex justify-between items-center: 플렉스 박스로 만들어서 양쪽에 요소를 배치. 페이지 번호 + 글쓰기 버튼
        px-2: 좌우에 약간의 패딩을 추가해서 살짝 여유 줌-->
    <div class="max-w-3xl mx-auto mt-8 flex justify-between items-center px-2">
      <!-- 페이지 번호 -->
      
      <!-- 게시글 작성 버튼 -->
      <!-- ml-auto: margin-left: auto → 오른쪽 끝으로 정렬해줌-->
      <div class="ml-auto">
          <!-- a 태그: 글쓰기 페이지로 이동하는 링크 (board_create.html)
              버튼 스타일:
              bg-[#10a37f]: 초록색 배경
              hover:bg-[#0d8f6d]: 마우스 올렸을 때 어두운 초록
              text-white: 글자색
              px-4 py-2: 패딩 (버튼 사이즈)
              rounded: 테두리 둥글게
              text-sm font-medium: 작은 글씨, 중간 굵기-->
          <a href="/board_create.html" 
            class="bg-[#10a37f] hover:bg-[#0d8f6d] text-white px-4 py-2 rounded text-sm font-medium">
            글쓰기
          </a>
        </div>
    </div>

    <!-- max-w-3xl mx-auto mt-8 flex items-center gap-2 px-2
        역시 중앙 정렬 (mx-auto) + 위 여백 (mt-8) + flex로 가로 배치
        gap-2: input과 button 사이에 공간 줌
        items-center: 세로 가운데 정렬-->
    <div class="max-w-3xl mx-auto mt-8 flex items-center gap-2 px-2">
      <!-- 검색 창 -->
      <!-- id="searchInput": 자바스크립트로 접근하기 위한 ID
          placeholder="제목 검색": 입력 칸에 흐릿하게 보이는 안내문
          flex-grow: input이 가로로 가능한 최대 너비를 차지
          bg-[#40414f]: 진한 회색 배경
          text-white, border, rounded: 시각적으로 깔끔한 입력창-->
      <input
        id="searchInput"
        type="text"
        placeholder="제목 검색"
        class="flex-grow px-4 py-2 bg-[#40414f] text-white border border-[#565869] rounded"
      />
      <!-- id="searchBtn": 자바스크립트에서 검색 기능에 연결
          스타일은 위 글쓰기 버튼과 유사 (초록색 배경, 둥근 모서리, hover 효과)-->
      <button
        id="searchBtn"
        class="bg-[#10a37f] hover:bg-[#0d8f6d] text-white px-4 py-2 rounded">
        검색
      </button>
    </div>
    <!-- id="pagination": 페이지 번호 버튼이 들어감 (JavaScript에서 renderPagination() 함수로 그려짐)-->
    <div id="pagination" class="flex justify-center mt-6 gap-2 text-sm text-gray-400"></div>
  </div>
  
  <script>
    const postList = document.getElementById('postList');
    const loginStatus = document.getElementById("loginStatus");
    const logoutBtn = document.getElementById("logoutBtn");
  
    let posts = [];
    const postsPerPage = 10;
    let currentPage = Math.ceil(posts.length / postsPerPage);
  
    /** ✅ 로그인 상태 표시 및 로그아웃 버튼 처리 **/
    function updateLoginUI() {
      const loginStatus = document.getElementById("loginStatus");
      const logoutBtn = document.getElementById("logoutBtn");

      const storedUser = localStorage.getItem("currentUser");
      let userInfo = null;

      try {
        if (storedUser) {
          userInfo = JSON.parse(storedUser);
        }
      } catch (err) {
        console.error("⚠️ currentUser 파싱 실패:", err);
      }
      
      if (userInfo) {
        loginStatus.textContent = `👋 ${userInfo.username}님 환영합니다!`;
        logoutBtn.classList.remove("hidden");
      } else {
        const currentUrl = encodeURIComponent(location.href);
        loginStatus.innerHTML = `<a href="login.html?redirect=${currentUrl}" class="text-blue-400 hover:underline">🔐 로그인</a>`;
        logoutBtn.classList.add("hidden");
      }
    }
  
    logoutBtn.addEventListener("click", () => {
      if (confirm("로그아웃 하시겠습니까?")) {
        localStorage.removeItem("currentUser");
        localStorage.removeItem("token");
        alert("로그아웃 되었습니다.");
        location.reload();
      }
    });
  
    /** ✅ 게시글 렌더링 함수 **/
    function renderPosts(postsArray, page = 1) {
      postList.innerHTML = "";
  
      const totalPages = Math.ceil(postsArray.length / postsPerPage);
      const startIndex = (totalPages - page) * postsPerPage;
      const endIndex = startIndex + postsPerPage;
      const paginatedPosts = postsArray.slice(startIndex, endIndex);
  
      paginatedPosts.forEach((post, idx) => {
        const postNumber = postsArray.length - (startIndex + idx);
        const date = new Date(post.date);
        const formattedDate = date.toLocaleString("ko-KR", {
          year: "2-digit",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit"
        }).replace(/\./g, '-').replace(/\s/g, '');
  
        const el = document.createElement("div");
        el.className = "flex items-center py-2 px-4 text-sm text-gray-300";
        el.innerHTML = `
          <div class="w-1/6 text-left">${postNumber}</div>
          <div class="w-3/6 text-center truncate">
            <a href="board_view.html?index=${post.id}" class="hover:underline text-white">${post.title}</a>
          </div>
          <div class="w-2/6 text-right">${formattedDate}</div>
        `;
        postList.appendChild(el);
      });
  
      renderPagination(postsArray);
    }
  
    /** ✅ 페이지네이션 표시 함수 **/
    function renderPagination(postsArray) {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
  
      const totalPages = Math.ceil(postsArray.length / postsPerPage);
      const groupSize = 10;
      const groupStart = Math.floor((currentPage - 1) / groupSize) * groupSize + 1;
      const groupEnd = Math.min(groupStart + groupSize - 1, totalPages);
  
      // ⏭ 첫 페이지로 이동
      const toFirst = document.createElement("button");
      toFirst.textContent = "⏭";
      toFirst.className = "px-2 py-1 text-sm text-gray-400 hover:text-white";
      toFirst.addEventListener("click", () => {
        currentPage = 1;
        renderPosts(postsArray, currentPage);
      });
      pagination.appendChild(toFirst);
  
      // ▶ 이전 페이지 그룹
      if (groupStart > 1) {
        const prev = document.createElement("button");
        prev.textContent = "▶";
        prev.className = "px-2 py-1 text-sm text-gray-400 hover:text-white";
        prev.addEventListener("click", () => {
          currentPage = groupStart - 1;
          renderPosts(postsArray, currentPage);
        });
        pagination.appendChild(prev);
      }
  
      // 페이지 번호 버튼
      for (let i = groupEnd; i >= groupStart; i--) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = `px-3 py-1 rounded hover:bg-[#3a3b3e] ${i === currentPage ? "bg-[#10a37f] text-white" : ""}`;
        btn.addEventListener("click", () => {
          currentPage = i;
          renderPosts(postsArray, currentPage);
        });
        pagination.appendChild(btn);
      }
  
      // ◀ 다음 페이지 그룹
      if (groupEnd < totalPages) {
        const next = document.createElement("button");
        next.textContent = "◀";
        next.className = "px-2 py-1 text-sm text-gray-400 hover:text-white";
        next.addEventListener("click", () => {
          currentPage = groupEnd + 1;
          renderPosts(postsArray, currentPage);
        });
        pagination.appendChild(next);
      }
  
      // ⏮ 마지막 페이지로 이동
      const toLast = document.createElement("button");
      toLast.textContent = "⏮";
      toLast.className = "px-2 py-1 text-sm text-gray-400 hover:text-white";
      toLast.addEventListener("click", () => {
        currentPage = totalPages;
        renderPosts(postsArray, currentPage);
      });
      pagination.appendChild(toLast);
    }
  
    /** ✅ 검색 기능 **/
    document.getElementById("searchBtn").addEventListener("click", () => {
      const keyword = document.getElementById("searchInput").value.toLowerCase();
  
      const filtered = posts.filter(post =>
        post.title.toLowerCase().includes(keyword)
      );
  
      if (keyword === "") {
        document.getElementById("pagination").style.display = "flex";
        renderPosts(posts, currentPage);
      } else {
        document.getElementById("pagination").style.display = "none";
        renderPosts(filtered, 1);
      }
    });
  
    /** ✅ 페이지 로드 시 데이터 가져오기 + 초기 렌더링 **/
    window.addEventListener("DOMContentLoaded", () => {
      updateLoginUI();
  
      fetch("http://localhost:4000/posts")
        .then(res => res.json())
        .then(data => {
          posts = data.sort((a, b) => b.id - a.id); // 최신순 정렬
          currentPage = Math.ceil(posts.length / postsPerPage);
          renderPosts(posts, currentPage);
        })
        .catch(err => {
          console.error("게시글 불러오기 실패:", err);
          postList.innerHTML = `<p class="text-center text-red-400 mt-4">게시글을 불러오는 중 오류가 발생했습니다.</p>`;
        });
    });
  
    /** ✅ 뒤로 가기 시 캐시된 페이지 새로고침 **/
    window.addEventListener("pageshow", (event) => {
      const navType = performance.getEntriesByType("navigation")[0]?.type;
      if (event.persisted || navType === "back_forward") {
        location.reload();
      }
    });
  </script>
  
  
  
</body>
</html>
