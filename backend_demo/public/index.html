<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CODE</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#232427] text-[#e5e7eb]">
  <div class="max-w-3xl mx-auto mt-10 space-y-6">
    <div class="board-wrapper">
      <!-- ì œëª© -->
      <header class="py-10 flex justify-center items-center ">
          <h1 class="text-5xl font-bold text-white">CODE</h1>
      </header>
    </div>

    <div class="flex justify-end items-center gap-4">
      <!-- âœ… ë¡œê·¸ì¸ ìƒíƒœ or ë¡œê·¸ì¸ ë²„íŠ¼ -->
      <div id="loginStatus" class="text-sm text-gray-400"></div>
      <!-- ğŸ”“ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
      <button id="logoutBtn" class="text-sm text-red-400 hover:underline hidden">ë¡œê·¸ì•„ì›ƒ</button>      
    </div>
    


    <div id="postList" class="max-w-3xl mx-auto mt-8 bg-[#2b2c30] rounded-xl shadow pd-10">
      <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
    </div>




    <div class="max-w-3xl mx-auto mt-8 flex justify-between items-center px-2">
      <!-- í˜ì´ì§€ ë²ˆí˜¸ -->
      
      <!-- ê²Œì‹œê¸€ ì‘ì„± ë²„íŠ¼ -->
      <div class="ml-auto">
          <a href="/board_create.html" 
            class="bg-[#10a37f] hover:bg-[#0d8f6d] text-white px-4 py-2 rounded text-sm font-medium">
            ê¸€ì“°ê¸°
          </a>
        </div>
    </div>

    <div class="max-w-3xl mx-auto mt-8 flex items-center gap-2 px-2">
      <!-- ê²€ìƒ‰ ì°½ -->
      <input
        id="searchInput"
        type="text"
        placeholder="ì œëª© ê²€ìƒ‰"
        class="flex-grow px-4 py-2 bg-[#40414f] text-white border border-[#565869] rounded"
      />
      <button
        id="searchBtn"
        class="bg-[#10a37f] hover:bg-[#0d8f6d] text-white px-4 py-2 rounded">
        ê²€ìƒ‰
      </button>
    </div>

    <div id="pagination" class="flex justify-center mt-6 gap-2 text-sm text-gray-400"></div>
  </div>

  <script>
    const postList = document.getElementById('postList');
    const rawPosts = JSON.parse(localStorage.getItem("posts") || "[]");
    const posts = rawPosts.map((post, index) => ({
      ...post,
      index,
      number: rawPosts.length - index
    }));

    const postsPerPage = 10;
    //const totalPages = Math.ceil(posts.length / postsPerPage);
    let currentPage = Math.ceil(posts.length / postsPerPage); // ê¸°ë³¸ì€ ìµœì‹ ê¸€ í˜ì´ì§€

    const userInfo = JSON.parse(localStorage.getItem("currentUser"));
    const loginStatus = document.getElementById("loginStatus");
    const logoutBtn = document.getElementById("logoutBtn");

    const urlParams = new URLSearchParams(location.search);
    if (urlParams.get("newPost")) {
      // í˜„ì¬ í˜ì´ì§€ë¥¼ ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ì„¤ì •
      currentPage = Math.ceil(posts.length / postsPerPage);
      
      // ì£¼ì†Œì—ì„œ ?newPost=1 ì œê±°í•´ì„œ ê¹”ë”í•˜ê²Œ
      history.replaceState(null, "", "index.html");
    }
    
    // index.html ë‚´ script íƒœê·¸ ì•ˆì— ì¶”ê°€í•´ì¤˜
    window.addEventListener("pageshow", (event) => {
      const navType = performance.getEntriesByType("navigation")[0]?.type;

      if (event.persisted || navType === "back_forward") {
        // ë¸Œë¼ìš°ì € ìºì‹œë¡œ ëŒì•„ì˜¨ ê²½ìš°ë¼ë©´
        location.reload(); // ê°•ì œë¡œ ìƒˆë¡œê³ ì¹¨
      }
    });


    
    if (userInfo) {
      loginStatus.textContent = `ğŸ‘‹ ${userInfo.username}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
      logoutBtn.classList.remove("hidden"); // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ë³´ì´ê¸°
    } else {
      // ğŸ” ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ì„ ë•Œ â†’ ë¡œê·¸ì¸ ë²„íŠ¼ìœ¼ë¡œ í‘œì‹œ
      const currentUrl = encodeURIComponent(location.href);
      loginStatus.innerHTML = `<a href="login.html?redirect=${currentUrl}" class="text-blue-400 hover:underline">ğŸ” ë¡œê·¸ì¸</a>`;
      logoutBtn.classList.add("hidden"); // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
    }
    
    // ë¡œê·¸ì•„ì›ƒ ë™ì‘
    logoutBtn.addEventListener("click", () => {
      if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        localStorage.removeItem("currentUser");
        alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.reload();
      }
    });

    // ğŸ” ì´ˆê¸° ì „ì²´ ì¶œë ¥
    renderPosts(currentPage);

    // ğŸ”¥ ê³µí†µ ë Œë”ë§ í•¨ìˆ˜
    function renderPosts(page = 1) {
      postList.innerHTML = "";
    
      const totalPages = Math.ceil(posts.length / postsPerPage);
      const startIndex = (totalPages - page) * postsPerPage;
      const endIndex = startIndex + postsPerPage;
    
      const paginatedPosts = posts.slice(startIndex, endIndex);
    
      paginatedPosts.forEach((post, idx) => {
        const postNumber = posts.length - (startIndex + idx);
        const date = new Date(post.date);
        const formattedDate = date.toLocaleString("ko-KR", {
          year: "2-digit",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        }).replace(/\./g, '-').replace(/\s/g, '');
    
        const el = document.createElement("div");
        el.className = "flex items-center py-2 px-4 text-sm text-gray-300";
    
        el.innerHTML = `
          <div class="w-1/6 text-left">${postNumber}</div>
          <div class="w-3/6 text-center truncate">
            <a href="board_view.html?index=${post.index}" class="hover:underline text-white">${post.title}</a>
          </div>
          <div class="w-2/6 text-right">${formattedDate}</div>
        `;
    
        postList.appendChild(el);
      });
    
      renderPagination();
    }
    
    
    

    function renderPagination() {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
    
      const totalPages = Math.ceil(posts.length / postsPerPage);
    
      const groupSize = 10; // ğŸ”¥ í•œ ë²ˆì— ë³´ì—¬ì¤„ í˜ì´ì§€ ìˆ˜
      const groupStart = Math.floor((currentPage - 1) / groupSize) * groupSize + 1;
      const groupEnd = Math.min(groupStart + groupSize - 1, totalPages);
    
      // â—€ ì™¼ìª½ í™”ì‚´í‘œ â†’ ë‹¤ìŒ ê·¸ë£¹ (ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™)
      if (groupEnd < totalPages) {
        const next = document.createElement("button");
        next.textContent = "â—€";
        next.className = "px-2 py-1 text-sm text-gray-400 hover:text-white";
        next.addEventListener("click", () => {
          currentPage = groupEnd + 1;
          renderPosts(currentPage);
        });
        pagination.appendChild(next);
      }
    
      // í˜ì´ì§€ ë²ˆí˜¸
      for (let i = groupEnd; i >= groupStart; i--) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = `px-3 py-1 rounded hover:bg-[#3a3b3e] ${
          i === currentPage ? "bg-[#10a37f] text-white" : ""
        }`;
        btn.addEventListener("click", () => {
          currentPage = i;
          renderPosts(currentPage);
        });
        pagination.appendChild(btn);
      }
    
      // â–¶ ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ â†’ ì´ì „ ê·¸ë£¹ (ì™¼ìª½ìœ¼ë¡œ ì´ë™)
      if (groupStart > 1) {
        const prev = document.createElement("button");
        prev.textContent = "â–¶";
        prev.className = "px-2 py-1 text-sm text-gray-400 hover:text-white";
        prev.addEventListener("click", () => {
          currentPage = groupStart - 1;
          renderPosts(currentPage);
        });
        pagination.appendChild(prev);
      }
    }
    
    

    function renderFilteredPosts(filteredPosts) {
      postList.innerHTML = "";
    
      filteredPosts.forEach(({ post, index }, i) => {
        const postNumber = filteredPosts.length - i;
        const date = new Date(post.date);
        const formattedDate = date.toLocaleString("ko-KR", {
          year: "2-digit", month: "2-digit", day: "2-digit",
          hour: "2-digit", minute: "2-digit"
        }).replace(/\./g, '-').replace(/\s/g, '');
    
        const el = document.createElement("div");
        el.className = "flex items-center py-2 px-4 text-sm text-gray-300";
    
        el.innerHTML = `
          <div class="w-1/6 text-left">${post.number}</div>
          <div class="w-3/6 text-center truncate">
            <a href="board_view.html?index=${post.index}" class="hover:underline text-white">${post.title}</a>
          </div>
          <div class="w-2/6 text-right">${formattedDate}</div>
        `;
    
        postList.appendChild(el);
      });
    
      // ê²€ìƒ‰ ì‹œì—ëŠ” í˜ì´ì§€ë„¤ì´ì…˜ ìˆ¨ê¹€
      document.getElementById("pagination").style.display = "none";
    }
    


    // ğŸ” ê²€ìƒ‰ ê¸°ëŠ¥
    document.getElementById("searchBtn").addEventListener("click", () => {
      const keyword = document.getElementById("searchInput").value.toLowerCase();
    
      const filtered = posts
        .map((post, index) => ({ post, index }))
        .filter(({ post }) => post.title.toLowerCase().includes(keyword));
    
      if (keyword === "") {
        // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì „ì²´ ë‹¤ì‹œ ë³´ì—¬ì£¼ê¸°
        document.getElementById("pagination").style.display = "flex";
        renderPosts(currentPage);
      } else {
        renderFilteredPosts(filtered);
      }
    });
    



     

  </script>
  
</body>
</html>
